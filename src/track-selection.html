<html>
<script>
  window.Elo = (function() {
    function getRatingDelta(myRating, opponentRating, myGameResult) {
      if ([0, 0.5, 1].indexOf(myGameResult) === -1) {
        return null;
      }

      var myChanceToWin = 1 / ( 1 + Math.pow(10, (opponentRating - myRating) / 400));

      return Math.round(32 * (myGameResult - myChanceToWin));
    }

    function getNewRating(myRating, opponentRating, myGameResult) {
      return myRating + getRatingDelta(myRating, opponentRating, myGameResult);
    }

      return {
        getRatingDelta: getRatingDelta,
        getNewRating: getNewRating
      };
  })();


  function flattenTracks(tracks) {
      let flatTracks = {};
      
      Object.keys(tracks).map((set) => {
          Object.keys(tracks[set]).map((cup) => {
              flatTracks = {
                  ...flatTracks,
                  ...tracks[set][cup],
              };
          });
      });
      return Object.values(flatTracks);
  }

function getRandomInt(max) {
  return Math.floor(Math.random() * Math.floor(max));
}

  const tracks = fetch('MarioKart8Tracks.json').then((res) => res.json());

  tracks.then((tracksList) => {
    let flatTracks = flattenTracks(tracksList);

    let ratings = window.localStorage.getItem('trackRatings');

    if (ratings) {
      ratings = JSON.parse(ratings);
    } else {
     ratings = new Array(flatTracks.length).fill(1400);
    }

    function getRandomTracks() {
      let track1 = getRandomInt(flatTracks.length - 1);
      let track2;
      do {
        track2 = getRandomInt(flatTracks.length - 1);
      } while (track1 === track2);
    
      return [track1,  track2];
    }

    let button1 = document.querySelector('#button-1');
    let button2 = document.querySelector('#button-2');

    let currentTracks;

    function showNewTracks() {
      currentTracks = getRandomTracks();
      button1.textContent = flatTracks[currentTracks[0]] + ': ' + ratings[currentTracks[0]];
      button2.textContent = flatTracks[currentTracks[1]] + ': ' + ratings[currentTracks[1]];
    }

    function onButtonClick(event) {
      let winner, loser;
      if (event.srcElement.id === 'button-1') {
        winner = currentTracks[0];
        loser = currentTracks[1];
      } else {
        winner = currentTracks[1];
        loser = currentTracks[0];
      }
      
      let oldWinnerRating = ratings[winner];
      let oldLoserRating = ratings[loser];

      let newWinnerRating = Elo.getNewRating(oldWinnerRating, oldLoserRating, 1);
      let newLoserRating = Elo.getNewRating(oldLoserRating, oldWinnerRating, 0);

      ratings[winner] = newWinnerRating;
      ratings[loser] = newLoserRating;

      window.localStorage.setItem('trackRatings', JSON.stringify(ratings));

      console.log('winnerRating', newWinnerRating);
      console.log('loserRating', newLoserRating);

      showNewTracks();
    }

    button1.addEventListener('click', onButtonClick);
    button2.addEventListener('click', onButtonClick);

    showNewTracks();


  });

</script>

<button id="button-1"></button>
<button id="button-2"></button>


</html>
